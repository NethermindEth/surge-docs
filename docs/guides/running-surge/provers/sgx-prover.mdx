---
sidebar_position: 1
---

import ConfigSetup from './_common/configs-setup.mdx';

# SGX Prover

This guide provides step-by-step instructions to set up the SGX prover for Surge using Docker. 
The SGX prover utilizes Intel's Software Guard Extensions (SGX) to create a secure environment for generating 
cryptographic proofs that validate Layer 2 blocks.

Sgx prover contains two components:
- `sgx-reth` prover - Rust sgx prover that generates proofs for the rollup.
- `sgx-geth` (Gaiko) prover - Golang sgx prover that generates proofs for the rollup.


### Prerequisites

- Machine with SGX support
- Docker
- L1 Accounts with funds (one for the prover, one for prover registry)
- L1 RPC URL

### 1. Fetch Collateral Information

First, fetch the collateral information from Intel:

```bash
FMSPC="00906ED50000"

TCB_FILE="tcb.json"
QE_IDENTITY_FILE="qe_identity.json"

curl -X GET "https://api.trustedservices.intel.com/sgx/certification/v3/tcb?fmspc=${FMSPC}" > ${TCB_FILE}
curl -X GET "https://api.trustedservices.intel.com/sgx/certification/v3/qe/identity" > ${QE_IDENTITY_FILE}

jq '.tcbInfo.fmspc |= ascii_downcase' ${TCB_FILE} > temp.json && mv temp.json ${TCB_FILE}
```


### 2. Generating PCCS Certificates
Before running the Raiko Docker container, you need to fulfill some SGX-specific prerequisites, 
which include setting up the PCCS (Provisioning Certificate Caching Service) configuration. 
The PCCS service is responsible for retrieving PCK Certificates and other collaterals on-demand 
from the internet at runtime, and then caching them in a local database. 
The PCCS exposes similar HTTPS interfaces as Intel's Provisioning Certificate Service.

Begin the configuration process by generating an SSL certificate:

```bash
mkdir ~/.config
mkdir ~/.config/sgx-pccs
cd ~/.config/sgx-pccs
openssl genrsa -out private.pem 2048
chmod 644 private.pem  # Docker container needs access
openssl req -new -key private.pem -out csr.pem
openssl x509 -req -days 365 -in csr.pem -signkey private.pem -out file.crt
rm csr.pem
```

Download the configuration file:

```bash
curl -s https://raw.githubusercontent.com/taikoxyz/raiko/refs/heads/main/docs/default.json > ~/.config/sgx-pccs/default.json
```

Make sure you've copied the default.json into the `.config/sgx-pccs` directory you created earlier. 
The raiko container will mount this as a volume. After copying the file, open it for editing and 
fill in the below listed parameters as recommended by Intel's manual:

* `ApiKey`: The PCCS uses this API key to request collaterals from Intel's Provisioning Certificate Service. User needs to subscribe first to obtain an API key. Use either the primary or secondary key you obtained from the previous step Subscribing to Intel PCS Service.

* `UserTokenHash`: SHA512 hash of the user token for the PCCS client user to register a platform. For example, PCK Cert ID retrieval tool will use the user token to send platform information to PCCS. (echo -n "user_password" | sha512sum | tr -d '[:space:]-').

* `AdminTokenHash`: SHA512 hash of the administrator token for the PCCS administrator to perform a manual refresh of cached artifacts (echo -n "admin_password" | sha512sum | tr -d '[:space:]-').

* `hosts`: Replace it with "0.0.0.0".

Ensure Docker can access the file by modifying its permissions:

```bash
chmod 644 default.json
```

:::note
This configuration only needs to be done once. You can skip this section for subsequent deployments.
:::


### 3. Setup Chain Spec and Config

<ConfigSetup/>



### 4. Configure Environment Variables

Copy sample `.env` file:

```bash
cd raiko/docker
cp .env.sample .env
```

Update .env file if needed, here are the important variables to check:

* `RAIKO_CONF_DIR` - Directory where your Raiko configuration files are stored. 
* `BASE_CONFIG_FILE` - Base configuration file for Raiko inside $RAIKO_CONF_DIR.
* `BASE_CHAINSPEC_FILE` - Base chainspec file for Raiko inside $RAIKO_CONF_DIR.
* `SGX_*_INSTANCE_ID` - Sgx Instance Id for specific hardfork.
* `SGXGETH_*_INSTANCE_ID` - SgxGeth (Gaiko) Instance Id for specific hardfork.
* `RUST_LOG` - Log level for Rust. Could be `info`, `debug`, `warn`, `error` or `trace`.


### 5. Build and Run 

Now you could run the prover. For that, you could either:

* Use a pre-built image from Docker Hub
* Build the image yourself

#### Using Pre-built Image from Docker Hub

The `docker-compose.yml` file uses the latest Raiko SGX image from Docker Hub by default.
Run the following commands:

```bash
cd docker # Navigate to the docker directory inside raiko
docker compose up init                    # Initialize the prover
docker compose up raiko -d --force-recreate  # Run the prover in detached mode
```

To use a specific version, update the image tag in the `docker-compose.yml` file.
Check the [Raiko repository](https://github.com/NethermindEth/raiko) for available releases.
Update the `image` field in `docker/docker-compose.yml` for both `raiko` and `init` services.

For example, if the latest release is v1.8.5-surge:

```yaml
services:
  init:
    image: nethermind.jfrog.io/core-oci-local-prod/raiko-sgx:v1.8.5-surge
    ...
  raiko:
    image: nethermind.jfrog.io/core-oci-local-prod/raiko-sgx:v1.8.5-surge
    ...
```

#### Build the Image Yourself

You may want to build the image yourself if you have made local changes to the Raiko codebase or want to use a specific commit.

To build the image from the `raiko` directory:

```bash
cd docker # Navigate to the docker directory inside raiko
docker compose up init --build # Build and Init the prover
docker compose up raiko -d --force-recreate --build # Build and Run the prover
```

### 6. Verify the Prover is Running

Your SGX prover should now be operational. To verify it's running correctly, check the container logs:

```bash
docker logs -f raiko
```

The next step is to register your prover in the protocol. Follow the instructions in the [Register Provers](../register-provers.mdx) guide.

:::note
If you encounter any issues while following these instructions, refer to the [Raiko Docker and RA Documentation](https://github.com/NethermindEth/raiko/blob/main/docs/README_Docker_and_RA.md) for additional guidance.
:::

